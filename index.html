<!DOCTYPE html>
<html>
<head>
    <title>WebGL BigInt Test</title>
    <style>
        body { font-family: sans-serif; }
        canvas { border: 1px solid black; }
    </style>
</head>
<body>
    <h1>WebGL BigInt Test Page</h1>
    <canvas id="glCanvas" width="256" height="256"></canvas>
    <p>Check the browser console for output.</p>

    <!-- Scripts are now loaded as modules -->
    <script type="module">
        import { BigIntPrimitive } from './src/bigint.js';

        // Shader sources (will be used by bigint.js)
        // Ideally, these would be loaded via fetch or part of a build process
        // For now, defining them globally so bigint.js can access them when it runs.
        const additionVertexShaderSource = `
            attribute vec2 a_position; // Vertex positions for a quad (e.g., -1 to 1)
            varying vec2 v_texCoord;   // Pass texcoord to fragment shader

            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
                v_texCoord = a_position * 0.5 + 0.5; // Convert from [-1,1] to [0,1]
            }
        `;

        const additionFragmentShaderSource = `
            precision highp float;

            uniform sampler2D u_num1Texture;
            uniform sampler2D u_num2Texture;
            uniform sampler2D u_carryTexture;
            varying vec2 v_texCoord;

            const float BASE = 10000.0;

            void main() {
                float limb1 = texture2D(u_num1Texture, v_texCoord).r;
                float limb2 = texture2D(u_num2Texture, v_texCoord).r;
                float carryIn = texture2D(u_carryTexture, v_texCoord).r;

                float sum = limb1 + limb2 + carryIn;

                float resultLimb = mod(sum, BASE);
                float carryOut = floor(sum / BASE);

                gl_FragColor = vec4(resultLimb, carryOut, 0.0, 1.0);
            }
        `;

        function manualTest() {
            console.log("Starting manual BigIntPrimitive test with WebGL...");

            const canvas = document.getElementById('glCanvas');
            if (!canvas) {
                console.error("Canvas element not found!");
                return;
            }

            // webgl-utils.js now exports its functions as an ES module.
            // bigint.js imports them. If bigint.js needs to expose them further, it would do so.
            // For this HTML page, direct access to webglUtils is no longer set up here.
            // If BigIntPrimitive needs shader sources, they must be passed or imported by it.
            // For now, bigint.js still relies on these being on `window`.
             window.vertexShaderSrc = additionVertexShaderSource;
             window.fragmentShaderSrc = additionFragmentShaderSource;


            try {
                const num1Str = "12345";
                const num2Str = "67890";
                // Sum:   80235

                console.log(`Attempting to add ${num1Str} and ${num2Str}`);
                // Pass canvas to constructor as it's now part of its signature
                const bigInt1 = new BigIntPrimitive(num1Str, canvas);
                const bigInt2 = new BigIntPrimitive(num2Str, canvas);

                // The canvas is stored in the instance by the constructor, so no need to attach it here.
                // bigInt1.canvas = canvas;
                // bigInt2.canvas = canvas;

                console.log("BigInts created:", bigInt1.toString(), bigInt2.toString());

                const sumBigInt = bigInt1.add(bigInt2);

                if (sumBigInt) {
                    console.log(`Sum: ${sumBigInt.toString()}`);
                    const expectedSum = "80235";
                    if (sumBigInt.toString() === expectedSum) {
                        console.info("Manual test PASSED!");
                    } else {
                        console.error(`Manual test FAILED! Expected ${expectedSum}, got ${sumBigInt.toString()}`);
                    }
                } else {
                    console.error("Addition returned undefined or null. WebGL part might have failed.");
                }

            } catch (e) {
                console.error("Error during manual test:", e.message, e.stack);
            }
        }

        // Wait for scripts to load before running the test
        window.onload = manualTest;
    </script>
</body>
</html>
